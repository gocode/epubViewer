<link rel="import" href="/static/bower_components/polymer/polymer.html">
<link rel="import" href="/static/bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="/static/bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="/static/bower_components/paper-button/paper-button.html">
<link rel="import" href="/static/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/static/bower_components/iron-icons/iron-icons.html">
<link rel="import" href="/static/bower_components/paper-fab/paper-fab.html">
<link rel="import" href="/static/bower_components/paper-styles/paper-styles.html">
<link rel="import" href="/static/bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="/static/bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="/static/bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="/static/bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="/static/bower_components/paper-slider/paper-slider.html">

<dom-module id="epub-viewer">

	<style>
		#body, paper-dialog-scrollable {
			display: flex;
			justify-content: center;
			align-items: center;
		}

		paper-toolbar, h2 {
			text-align: center;
		}

		#epubviewer {			
	 		height: 600px;
	    	width: 100%;
	    	border-width: 0px;
	    }

	    paper-fab {
			margin: 30px;
			background: #3f51b5;
			color: #fff;
		}

		paper-dialog {
			height: 500px;
			width: 500px;
		}

		paper-slider {
			width: 80%;
		}

		paper-dialog paper-icon-button {
			color: #3f51b5;
			margin-right: 10px;
		}

		paper-dialog span {
			float: left;
			width: 100px;
			padding-top: 10px;
		}

		paper-dialog paper-button {
			background: #3f51b5;
			color: #fff;
		}
	</style>

	<template>

			<paper-toolbar>
				<div class="title">Epub Reader</div>
				<paper-button on-click="openSettingsDialog">
					<paper-icon-button icon="settings"></paper-icon-button>
				</paper-button>
			</paper-toolbar>

			<div id="body">
				<paper-fab id="prevbtn" on-click="prev" icon="arrow-back"></paper-fab>
				<iframe name="epubviewer" id="epubviewer"></iframe>
				<paper-fab id="nextbtn" on-click="next" icon="arrow-forward"></paper-fab>
			</div>

			<paper-dialog id="dialog">
				<h2>Settings </h2>
					<paper-dialog-scrollable>
					  	<div class="vertical-section">
							<div>Font</div>
							<paper-radio-group selected="{{fontFamily}}">
								<paper-radio-button name="Roboto">Roboto</paper-radio-button>
								<paper-radio-button name="Cursive">Cursive</paper-radio-button>
								<paper-radio-button name="sans-serif">Sans Serif</paper-radio-button>
							</paper-radio-group>				
							<div>Font Size</div>
							<paper-slider class="blue" value="{{fontSize}}" max="32" editable></paper-slider>

							<div>
								<span>Left Margin</span>
								<paper-icon-button icon="add" on-click="incMarginLeft"></paper-icon-button>
								<paper-icon-button icon="remove" on-click="decMarginLeft"></paper-icon-button>
							</div>
							<div>
								<span>Right Margin</span>
								<paper-icon-button icon="add" on-click="incMarginRight"></paper-icon-button>
								<paper-icon-button icon="remove" on-click="decMarginRight"></paper-icon-button>
							</div>
							<div>
								<span>Top Margin</span>
								<paper-icon-button icon="add" on-click="incMarginTop"></paper-icon-button>
								<paper-icon-button icon="remove" on-click="decMarginTop"></paper-icon-button>
							</div>
							<div>
								<span>Bottom Margin</span>
								<paper-icon-button icon="add" on-click="incMarginBottom"></paper-icon-button>
								<paper-icon-button icon="remove" on-click="incMarginBottom"></paper-icon-button>
							</div>
						</div>

					</paper-dialog-scrollable>
				<div class="buttons">
					<paper-button dialog-dismiss>Cancel</paper-button>
					<paper-button dialog-confirm autofocus on-click="changeSettings">OK</paper-button>
				</div>
			</paper-dialog>	

	</template>

	<script>
		Polymer({
			is: "epub-viewer",

			properties: {
				filename: String,
				src: String,
				href: {
					type: String,
					computed: 'computeHref(filename, src)'
				},
				fontFamily: {
					type: String,
					value: 'Cursive'
				},
				fontSize: {
					type: Number,
					value: 18
				},
				marginLeft: {
					type: Number,
					value: 20
				},
				marginRight: {
					type: Number,
					value: 20
				},
				marginTop: {
					type: Number,
					value: 20
				},
				marginBottom: {
					type: Number,
					value: 20
				}
			},

			ready: function() {
				window.addEventListener('popstate', function(e) {
					console.log('back');
					 //document.location = e.state;
				});

				var that = this;

				this.$.epubviewer.addEventListener('load', function() {
					var y=(this.contentWindow || this.contentDocument);          

					y.addEventListener('keydown', function(e) {
						var evnt = new CustomEvent("click", { 'detail': 'Page navigation event' });
						if (e.keyCode == '37') {
							that.$.prevbtn.dispatchEvent(evnt);
						} else if (e.keyCode == '39') {
							that.$.nextbtn.dispatchEvent(evnt);
						}
					});

					var x = y.document.querySelector('body');
					x.style.fontFamily = that.fontFamily;
					x.style.fontSize = that.fontSize + 'px';
					x.style.marginLeft = that.marginLeft + 'px';
					x.style.marginRight = that.marginRight + 'px';
					x.style.marginTop = that.marginTop + 'px';
					x.style.marginBottom = that.marginBottom + 'px';
				});

				document.addEventListener('click', function() {
					that.$.epubviewer.focus();
				});

				this.$.epubviewer.focus();
			},

			computeHref: function(filename, src) {
				return '/epubviewer/' + filename + '/' + src;
			},

			attached: function() {
				var url = document.location.pathname.split("/");
				this.filename = url[2];
				this.src = url[3];
				for (var i = 4, len = url.length; i<len; i++){
    				this.src = this.src + '/' + url[i];
				}
				document.cookie = 'bookname=' + this.filename +';path=/';
				history.pushState(null, null, this.href);
				this.$.epubviewer.src = 'http://localhost:9090/' + this.src;
			},

			next: function() {
				var that = this;
				jQuery.ajax({
				    url: '/nextpage',
				    data: {
				    	bookname: that.filename,
				    	href: that.$.epubviewer.contentWindow.location.pathname
				    },
				    type: 'POST',
				    success: function(data){
				    	that.src =  JSON.parse(data).Href;
				    	history.pushState(null, null, that.href);
				    	that.$.epubviewer.src = '/' + that.src;
				    }
				});
			},

			prev: function() {
				var that = this;
				jQuery.ajax({
				    url: '/prevpage',
				    data: {
				    	bookname: that.filename,
				    	href: that.$.epubviewer.contentWindow.location.pathname
				    },
				    type: 'POST',
				    success: function(data){
				    	that.src =  JSON.parse(data).Href;
				    	history.pushState(null, null, that.href);
				    	that.$.epubviewer.src = '/' + that.src;
				    }
				});
			},

			openSettingsDialog: function() {
				this.$.dialog.open();
			},

			openFontDropDown: function() {
				this.$.fontDropDown.open();
			},

			incMarginLeft: function() {
				this.marginLeft += 10;
			},

			decMarginLeft: function() {
				this.marginLeft -= 10;
			},

			incMarginRight: function() {
				this.marginRight += 10;
			},

			decMarginRight: function() {
				this.marginRight -= 10;
			},

			incMarginTop: function() {
				this.marginTop += 10;
			},

			decMarginTop: function() {
				this.marginTop -= 10;
			},

			incMarginBottom: function() {
				this.marginBottom += 10;
			},

			decMarginBottom: function() {
				this.marginBottom -= 10;
			},

			changeSettings: function() {
				var y=(this.$.epubviewer.contentWindow || this.$.epubviewer.contentDocument);          
				var x = y.document.querySelector('body');
				x.style.fontFamily = this.fontFamily;
				x.style.fontSize = this.fontSize + 'px';
				x.style.marginLeft = this.marginLeft + 'px';
				x.style.marginRight = this.marginRight + 'px';
				x.style.marginTop = this.marginTop + 'px';
				x.style.marginBottom = this.marginBottom + 'px';
			}
		});
	</script>

</dom-module>