<link rel="import" href="/static/bower_components/polymer/polymer.html">
<link rel="import" href="/static/bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="/static/bower_components/paper-button/paper-button.html">
<link rel="import" href="/static/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/static/bower_components/iron-icons/iron-icons.html">
<link rel="import" href="/static/bower_components/paper-fab/paper-fab.html">

<link rel="import" href="/static/settings-dialog.html">

<dom-module id="epub-viewer">

	<style>
		#body {
			display: flex;
			justify-content: center;
			align-items: center;
		}

		paper-toolbar {
			text-align: center;
		}

		#epubviewer {			
	    	height: 600px;
	    	width: 100%;
	    	border-width: 0px;
	    }

	    paper-fab {
			margin: 30px;
			background: #3f51b5;
			color: #fff;
		}
	</style>

	<template>
		<paper-toolbar>
			<div class="title">Epub Reader</div>
			<paper-button on-click="openSettingsDialog">
				<paper-icon-button icon="settings"></paper-icon-button>
			</paper-button>
		</paper-toolbar>

		<div id="body">
			<paper-fab on-click="prev" icon="arrow-back"></paper-fab>
			<iframe id="epubviewer"></iframe>
			<paper-fab on-click="next" icon="arrow-forward"></paper-fab>
		</div>

		<settings-dialog id="dialog">
		</settings-dialog>
	</template>

	<script>
		Polymer({
			is: "epub-viewer",

			properties: {
				filename: String,
				src: String,
				href: {
					type: String,
					computed: 'computeHref(filename, src)'
				}
			},

			ready: function() {
				window.addEventListener('popstate', function() {

				});
			},

			computeHref: function(filename, src) {
				return '/epubviewer/' + filename + '/' + src;
			},

			attached: function() {
				var url = document.location.pathname.split("/");
				this.filename = url[2];
				this.src = url[3];
				for (var i = 4, len = url.length; i<len; i++){
    				this.src = this.src + '/' + url[i];
				}
				history.pushState(null, null, this.href);
				this.$.epubviewer.src = 'http://localhost:9090/' + this.src;
			},

			next: function() {
				var that = this;
				jQuery.ajax({
				    url: '/nextpage',
				    data: {href: that.$.epubviewer.contentWindow.location.pathname},
				    type: 'POST',
				    success: function(data){
				    	that.src =  JSON.parse(data).Href;
				    	history.pushState(null, null, that.href);
				    	that.$.epubviewer.src = '/' + that.src;
				    }
				});
			},

			prev: function() {
				var that = this;
				jQuery.ajax({
				    url: '/prevpage',
				    data: {href: that.$.epubviewer.contentWindow.location.pathname},
				    type: 'POST',
				    success: function(data){
				    	that.src =  JSON.parse(data).Href;
				    	history.pushState(null, null, that.href);
				    	that.$.epubviewer.src = '/' + that.src;
				    }
				});
			},

			openSettingsDialog: function() {
				this.$.dialog.open();
			}
		});
	</script>

</dom-module>